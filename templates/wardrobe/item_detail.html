{% extends 'base.html' %}
{% load static %}

{% block title %}{{ item.name }} - AI Stylist{% endblock %}

{% block content %}
<div class="container py-4">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <nav aria-label="breadcrumb">
                        <ol class="breadcrumb mb-2">
                            <li class="breadcrumb-item"><a href="{% url 'wardrobe' %}" class="text-decoration-none">Wardrobe</a></li>
                            <li class="breadcrumb-item active" aria-current="page">{{ item.name|truncatechars:30 }}</li>
                        </ol>
                    </nav>
                    <h1 class="h2 mb-0">{{ item.name }}</h1>
                </div>
                <div class="dropdown">
                    <button class="btn btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false">
                        <i class="bi bi-three-dots-vertical"></i>
                    </button>
                    <ul class="dropdown-menu">
                        <li><button class="dropdown-item" data-bs-toggle="modal" data-bs-target="#editModal">
                            <i class="bi bi-pencil me-2"></i>Edit Item
                        </button></li>
                        <li><button class="dropdown-item text-danger" data-bs-toggle="modal" data-bs-target="#deleteModal">
                            <i class="bi bi-trash me-2"></i>Delete Item
                        </button></li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
    
    <div class="row">
        <!-- Image Section -->
        <div class="col-lg-6 mb-4">
            <div class="card border-0 shadow-sm">
                <div class="card-body p-0">
                    <div class="position-relative">
                        {% if item.image %}
                        <img src="{{ item.image.url }}" 
                             class="img-fluid w-100 rounded" 
                             alt="{{ item.name }}"
                             style="max-height: 500px; object-fit: contain; background-color: #f8f9fa;">
                        {% else %}
                        <div class="bg-light d-flex align-items-center justify-content-center rounded" style="height: 400px;">
                            <i class="bi bi-image text-muted" style="font-size: 4rem;"></i>
                        </div>
                        {% endif %}
                        
                        <!-- Favorite Button -->
                        <button class="btn position-absolute top-0 end-0 m-3 favorite-btn" 
                                data-item-id="{{ item.item_id }}"
                                data-is-favorite="{{ item.is_favorite|yesno:'true,false' }}">
                            <i class="bi {% if item.is_favorite %}bi-heart-fill text-danger{% else %}bi-heart text-white{% endif %}"></i>
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- AI Analysis Section -->
            {% if item.cv_confidence %}
            <div class="card border-0 shadow-sm mt-3">
                <div class="card-header bg-transparent border-0">
                    <h6 class="mb-0">
                        <i class="bi bi-robot me-2 text-primary"></i>AI Analysis
                    </h6>
                </div>
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <span class="text-muted">Confidence Score</span>
                        <div class="d-flex align-items-center">
                            <div class="progress me-2" style="width: 100px; height: 8px;">
                                <div class="progress-bar bg-success" 
                                     style="width: {{ item.cv_confidence|floatformat:0|add:'0' }}%"></div>
                            </div>
                            <span class="badge bg-success">{{ item.cv_confidence|floatformat:0 }}%</span>
                        </div>
                    </div>
                    
                    {% if item.cv_metadata %}
                    <div class="row g-2 text-sm">
                        {% if item.cv_metadata.detected_category %}
                        <div class="col-6">
                            <small class="text-muted">Detected Category:</small><br>
                            <span class="badge bg-primary">{{ item.cv_metadata.detected_category|capfirst }}</span>
                        </div>
                        {% endif %}
                        
                        {% if item.cv_metadata.detected_colors %}
                        <div class="col-6">
                            <small class="text-muted">Detected Colors:</small><br>
                            {% for color in item.cv_metadata.detected_colors %}
                            <span class="badge bg-info me-1">{{ color|capfirst }}</span>
                            {% endfor %}
                        </div>
                        {% endif %}
                    </div>
                    {% endif %}
                </div>
            </div>
            {% endif %}
        </div>
        
        <!-- Details Section -->
        <div class="col-lg-6">
            <div class="card border-0 shadow-sm">
                <div class="card-body">
                    <!-- Basic Info -->
                    <div class="row mb-4">
                        <div class="col-6">
                            <label class="form-label text-muted small">Category</label>
                            <div class="fw-semibold">
                                <i class="bi bi-grid me-2 text-primary"></i>
                                {{ item.get_category_display }}
                            </div>
                        </div>
                        <div class="col-6">
                            <label class="form-label text-muted small">Primary Color</label>
                            <div class="fw-semibold">
                                <i class="bi bi-palette me-2 text-primary"></i>
                                {{ item.get_color_display }}
                            </div>
                        </div>
                    </div>
                    
                    {% if item.secondary_color and item.secondary_color != item.color %}
                    <div class="row mb-4">
                        <div class="col-6">
                            <label class="form-label text-muted small">Secondary Color</label>
                            <div class="fw-semibold">
                                <i class="bi bi-palette2 me-2 text-primary"></i>
                                {{ item.get_secondary_color_display }}
                            </div>
                        </div>
                    </div>
                    {% endif %}
                    
                    {% if item.brand or item.season != 'all_season' %}
                    <div class="row mb-4">
                        {% if item.brand %}
                        <div class="col-6">
                            <label class="form-label text-muted small">Brand</label>
                            <div class="fw-semibold">
                                <i class="bi bi-award me-2 text-primary"></i>
                                {{ item.brand }}
                            </div>
                        </div>
                        {% endif %}
                        
                        {% if item.season != 'all_season' %}
                        <div class="col-6">
                            <label class="form-label text-muted small">Season</label>
                            <div class="fw-semibold">
                                <i class="bi bi-thermometer-half me-2 text-primary"></i>
                                {{ item.get_season_display }}
                            </div>
                        </div>
                        {% endif %}
                    </div>
                    {% endif %}
                    
                    <!-- Stats -->
                    <div class="row mb-4">
                        <div class="col-6">
                            <label class="form-label text-muted small">Times Worn</label>
                            <div class="fw-semibold">
                                <i class="bi bi-eye me-2 text-primary"></i>
                                {{ item.wear_count }}
                            </div>
                        </div>
                        <div class="col-6">
                            <label class="form-label text-muted small">Added On</label>
                            <div class="fw-semibold">
                                <i class="bi bi-calendar me-2 text-primary"></i>
                                {{ item.created_at|date:"M j, Y" }}
                            </div>
                        </div>
                    </div>
                    
                    {% if item.price or item.purchase_date %}
                    <div class="row mb-4">
                        {% if item.price %}
                        <div class="col-6">
                            <label class="form-label text-muted small">Price</label>
                            <div class="fw-semibold">
                                <i class="bi bi-currency-dollar me-2 text-primary"></i>
                                ${{ item.price }}
                            </div>
                        </div>
                        {% endif %}
                        
                        {% if item.purchase_date %}
                        <div class="col-6">
                            <label class="form-label text-muted small">Purchase Date</label>
                            <div class="fw-semibold">
                                <i class="bi bi-calendar3 me-2 text-primary"></i>
                                {{ item.purchase_date|date:"M j, Y" }}
                            </div>
                        </div>
                        {% endif %}
                    </div>
                    {% endif %}
                    
                    <!-- Tags -->
                    {% if tags %}
                    <div class="mb-4">
                        <label class="form-label text-muted small">Tags</label>
                        <div class="mt-2">
                            {% for tag in tags %}
                            <span class="badge me-1 mb-1 {% if tag.source == 'cv' %}bg-info{% else %}bg-secondary{% endif %}">
                                {{ tag.tag }}
                                {% if tag.source == 'cv' %}
                                <i class="bi bi-robot ms-1" title="AI Generated"></i>
                                {% endif %}
                            </span>
                            {% endfor %}
                        </div>
                        <small class="text-muted">
                            <i class="bi bi-info-circle me-1"></i>
                            Blue tags are AI-generated, gray tags are user-added
                        </small>
                    </div>
                    {% endif %}
                    
                    <!-- Actions -->
                    <div class="d-flex gap-2 mt-4">
                        <a href="{% url 'edit_item' item.item_id %}" class="btn btn-primary flex-fill">
                            <i class="bi bi-pencil me-2"></i>Edit Item
                        </a>
                        <button class="btn btn-outline-danger" data-bs-toggle="modal" data-bs-target="#deleteModal">
                            <i class="bi bi-trash me-1"></i>Delete Item
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Wear History (if any) -->
            {% if item.last_worn %}
            <div class="card border-0 shadow-sm mt-3">
                <div class="card-header bg-transparent border-0">
                    <h6 class="mb-0">
                        <i class="bi bi-clock-history me-2 text-primary"></i>Wear History
                    </h6>
                </div>
                <div class="card-body">
                    <p class="mb-2">Last worn: <strong>{{ item.last_worn|date:"M j, Y" }}</strong></p>
                    <div class="progress mb-2" style="height: 6px;">
                        <div class="progress-bar bg-success" 
                             style="width: {% widthratio item.wear_count 10 100 %}%"></div>
                    </div>
                    <small class="text-muted">
                        {% if item.wear_count >= 10 %}
                        Frequently worn item
                        {% elif item.wear_count >= 5 %}
                        Moderately worn item
                        {% elif item.wear_count > 0 %}
                        Occasionally worn item
                        {% else %}
                        Never worn yet
                        {% endif %}
                    </small>
                </div>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteModal" tabindex="-1" aria-labelledby="deleteModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="deleteModalLabel">Delete Clothing Item</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete <strong>"{{ item.name }}"</strong> from your wardrobe?</p>
                <p class="text-muted small">This action cannot be undone. The item will be permanently removed.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <form method="post" action="{% url 'delete_item' item.item_id %}" class="d-inline">
                    {% csrf_token %}
                    <button type="submit" class="btn btn-danger">Delete Item</button>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_head %}
<style>
.favorite-btn {
    background: rgba(0, 0, 0, 0.6);
    backdrop-filter: blur(4px);
    border: none;
    width: 40px;
    height: 40px;
    border-radius: 50%;
    color: white;
    transition: all 0.3s ease;
}

.favorite-btn:hover {
    background: rgba(0, 0, 0, 0.8);
    transform: scale(1.1);
    color: white;
}

.favorite-btn:focus {
    box-shadow: 0 0 0 0.2rem rgba(111, 66, 193, 0.25);
    color: white;
}

.badge.bg-info {
    background-color: rgba(13, 202, 240, 0.1) !important;
    color: #0dcaf0 !important;
    border: 1px solid #0dcaf0;
}

.badge.bg-secondary {
    background-color: rgba(108, 117, 125, 0.1) !important;
    color: #6c757d !important;
    border: 1px solid #6c757d;
}

.progress {
    background-color: rgba(111, 66, 193, 0.1);
}

.breadcrumb-item a:hover {
    color: var(--primary-color);
}

@media (max-width: 768px) {
    .col-lg-6:first-child {
        margin-bottom: 1rem;
    }
    
    .row.mb-4 .col-6 {
        margin-bottom: 1rem;
    }
}
</style>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const favoriteBtn = document.querySelector('.favorite-btn');
    
    if (favoriteBtn) {
        favoriteBtn.addEventListener('click', async function(e) {
            e.preventDefault();
            
            const itemId = this.dataset.itemId;
            const isFavorite = this.dataset.isFavorite === 'true';
            
            try {
                const response = await fetch(`/wardrobe/item/${itemId}/toggle-favorite/`, {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': '{{ csrf_token }}',
                        'Content-Type': 'application/json',
                    },
                    credentials: 'same-origin'
                });
                
                const data = await response.json();
                
                if (data.success) {
                    const icon = this.querySelector('i');
                    
                    if (data.is_favorite) {
                        icon.className = 'bi bi-heart-fill text-danger';
                        this.dataset.isFavorite = 'true';
                    } else {
                        icon.className = 'bi bi-heart text-white';
                        this.dataset.isFavorite = 'false';
                    }
                    
                    AIStylist.ui.showToast(data.message, 'success');
                }
            } catch (error) {
                console.error('Error toggling favorite:', error);
                AIStylist.ui.showToast('Failed to update favorite status', 'error');
            }
        });
    }
});
</script>
{% endblock %}
