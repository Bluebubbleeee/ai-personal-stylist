{% extends 'base.html' %}
{% load static %}

{% block title %}My Wardrobe - AI Stylist{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center flex-wrap">
                <div class="mb-2 mb-sm-0">
                    <h1 class="h2 mb-1">
                        {% if favorites_only %}
                            <i class="bi bi-heart-fill text-danger me-2"></i>Favorite Items
                        {% else %}
                            My Wardrobe
                        {% endif %}
                    </h1>
                    <p class="text-muted mb-0">
                        {% if favorites_only %}
                            {{ total_items }} favorite item{{ total_items|pluralize }} in your collection
                        {% else %}
                            {{ total_items }} item{{ total_items|pluralize }} in your collection
                        {% endif %}
                    </p>
                </div>
                <div class="d-flex gap-2">
                    {% if favorites_only %}
                        <a href="{% url 'wardrobe' %}" class="btn btn-outline-secondary">
                            <i class="bi bi-collection me-1"></i>Show All Items
                        </a>
                    {% endif %}
                    <a href="{% url 'wardrobe_upload' %}" class="btn btn-primary">
                        <i class="bi bi-plus-lg me-1"></i>Add Clothes
                    </a>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Search and Filters -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card border-0 shadow-sm">
                <div class="card-body py-3">
                    <form method="get" id="filterForm" class="row g-3 align-items-center">
                        <!-- Search -->
                        <div class="col-md-4">
                            <div class="input-group">
                                <span class="input-group-text bg-light border-end-0">
                                    <i class="bi bi-search text-muted"></i>
                                </span>
                                <input type="text" 
                                       class="form-control border-start-0" 
                                       name="q" 
                                       value="{{ search_query }}" 
                                       placeholder="Search your wardrobe..."
                                       id="searchInput">
                            </div>
                        </div>
                        
                        <!-- Category Filter -->
                        <div class="col-md-3">
                            <select name="category" class="form-select" id="categoryFilter">
                                <option value="">All Categories</option>
                                {% for value, label in categories %}
                                <option value="{{ value }}" {% if category_filter == value %}selected{% endif %}>
                                    {{ label }}
                                </option>
                                {% endfor %}
                            </select>
                        </div>
                        
                        <!-- Color Filter -->
                        <div class="col-md-3">
                            <select name="color" class="form-select" id="colorFilter">
                                <option value="">All Colors</option>
                                {% for value, label in colors %}
                                <option value="{{ value }}" {% if color_filter == value %}selected{% endif %}>
                                    {{ label }}
                                </option>
                                {% endfor %}
                            </select>
                        </div>
                        
                        <!-- Clear Filters -->
                        <div class="col-md-2 text-end">
                            <button type="button" class="btn btn-outline-secondary btn-sm" id="clearFilters">
                                <i class="bi bi-x-lg me-1"></i>Clear
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Items Grid -->
    {% if items %}
    <div class="row" id="itemsGrid">
        {% for item in items %}
        <div class="col-xl-2 col-lg-3 col-md-4 col-sm-6 mb-4">
            <div class="card clothing-card h-100 border-0 shadow-sm">
                <!-- Item Image -->
                <div class="position-relative image-container">
                    {% if item.thumbnail %}
                        <img src="{{ item.thumbnail.url }}" 
                             class="card-img-top clothing-image" 
                             alt="{{ item.name }}"
                             loading="lazy"
                             data-full-image="{% if item.image %}{{ item.image.url }}{% else %}{{ item.thumbnail.url }}{% endif %}">
                    {% elif item.image %}
                        <img src="{{ item.image.url }}" 
                             class="card-img-top clothing-image" 
                             alt="{{ item.name }}"
                             loading="lazy"
                             data-full-image="{{ item.image.url }}">
                    {% else %}
                        <div class="card-img-top clothing-image bg-light d-flex align-items-center justify-content-center">
                            <i class="bi bi-image text-muted" style="font-size: 3rem;"></i>
                        </div>
                    {% endif %}
                    
                    <!-- Image Zoom Overlay -->
                    <div class="image-zoom-overlay">
                        <i class="bi bi-zoom-in text-white"></i>
                    </div>
                    
                    <!-- Favorite Toggle -->
                    <button class="btn btn-sm position-absolute top-0 end-0 m-2 favorite-btn border-0" 
                            data-item-id="{{ item.item_id }}"
                            data-is-favorite="{{ item.is_favorite|yesno:'true,false' }}">
                        <i class="bi {% if item.is_favorite %}bi-heart-fill text-danger{% else %}bi-heart text-white{% endif %}"></i>
                    </button>
                    
                    <!-- Category Badge -->
                    <span class="badge bg-primary position-absolute bottom-0 start-0 m-2">
                        {{ item.get_category_display }}
                    </span>
                </div>
                
                <!-- Item Details -->
                <div class="card-body p-3">
                    <h6 class="card-title mb-2 fw-semibold">{{ item.name|truncatechars:30 }}</h6>
                    
                    <!-- Colors -->
                    <div class="d-flex align-items-center mb-2">
                        <small class="text-muted">
                            <i class="bi bi-palette me-1"></i>
                            {{ item.get_color_display }}
                            {% if item.secondary_color and item.secondary_color != item.color %}
                                + {{ item.get_secondary_color_display }}
                            {% endif %}
                        </small>
                    </div>
                    
                    <!-- Tags -->
                    {% if item.tags.all %}
                    <div class="mb-2">
                        {% for tag in item.tags.all|slice:":3" %}
                        <span class="badge bg-light text-dark me-1 mb-1 small">{{ tag.tag }}</span>
                        {% endfor %}
                        {% if item.tags.count > 3 %}
                        <span class="badge bg-light text-muted small">+{{ item.tags.count|add:"-3" }}</span>
                        {% endif %}
                    </div>
                    {% endif %}
                    
                    <!-- Stats -->
                    <div class="d-flex justify-content-between align-items-center text-muted small">
                        <span>
                            <i class="bi bi-eye me-1"></i>
                            Worn {{ item.wear_count }} time{{ item.wear_count|pluralize }}
                        </span>
                        {% if item.brand %}
                        <span class="text-end">{{ item.brand|truncatechars:15 }}</span>
                        {% endif %}
                    </div>
                </div>
                
                <!-- Action Footer -->
                <div class="card-footer bg-transparent border-0 p-3 pt-0">
                    <a href="/wardrobe/item/{{ item.item_id }}/" class="btn btn-outline-primary btn-sm w-100">
                        <i class="bi bi-eye me-1"></i>View Details
                    </a>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
    
    <!-- Pagination -->
    {% if items.has_other_pages %}
    <div class="row mt-4">
        <div class="col-12">
            <nav aria-label="Wardrobe pagination">
                <ul class="pagination justify-content-center">
                    {% if items.has_previous %}
                    <li class="page-item">
                        <a class="page-link" href="?page={{ items.previous_page_number }}{% if search_query %}&q={{ search_query }}{% endif %}{% if category_filter %}&category={{ category_filter }}{% endif %}{% if color_filter %}&color={{ color_filter }}{% endif %}">
                            <i class="bi bi-chevron-left"></i>
                        </a>
                    </li>
                    {% endif %}
                    
                    {% for num in items.paginator.page_range %}
                    {% if items.number == num %}
                    <li class="page-item active">
                        <span class="page-link">{{ num }}</span>
                    </li>
                    {% elif num > items.number|add:'-3' and num < items.number|add:'3' %}
                    <li class="page-item">
                        <a class="page-link" href="?page={{ num }}{% if search_query %}&q={{ search_query }}{% endif %}{% if category_filter %}&category={{ category_filter }}{% endif %}{% if color_filter %}&color={{ color_filter }}{% endif %}">{{ num }}</a>
                    </li>
                    {% endif %}
                    {% endfor %}
                    
                    {% if items.has_next %}
                    <li class="page-item">
                        <a class="page-link" href="?page={{ items.next_page_number }}{% if search_query %}&q={{ search_query }}{% endif %}{% if category_filter %}&category={{ category_filter }}{% endif %}{% if color_filter %}&color={{ color_filter }}{% endif %}">
                            <i class="bi bi-chevron-right"></i>
                        </a>
                    </li>
                    {% endif %}
                </ul>
            </nav>
        </div>
    </div>
    {% endif %}
    
    {% else %}
    <!-- Empty State -->
    <div class="row">
        <div class="col-12">
            <div class="text-center py-5">
                {% if search_query or category_filter or color_filter %}
                <!-- No Results -->
                <div class="empty-state">
                    <i class="bi bi-search display-1 text-muted mb-3"></i>
                    <h3 class="text-muted">No items found</h3>
                    <p class="text-muted">Try adjusting your search or filters.</p>
                    <button class="btn btn-primary" id="clearFilters">
                        <i class="bi bi-x-lg me-2"></i>Clear Filters
                    </button>
                </div>
                {% else %}
                <!-- Empty Wardrobe -->
                <div class="empty-state">
                    <i class="bi bi-bag display-1 text-muted mb-3"></i>
                    <h3 class="text-muted">Your wardrobe is empty</h3>
                    <p class="text-muted mb-4">Start building your digital wardrobe by uploading photos of your clothes.</p>
                    <a href="{% url 'wardrobe_upload' %}" class="btn btn-primary btn-lg">
                        <i class="bi bi-plus-lg me-2"></i>Add Your First Item
                    </a>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
    {% endif %}
</div>

<!-- Image Modal -->
<div class="modal fade" id="imageModal" tabindex="-1" aria-labelledby="imageModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="imageModalLabel">Item Image</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body text-center p-0">
                <img id="modalImage" class="img-fluid" style="max-height: 70vh; object-fit: contain;" alt="Item Image">
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_head %}
<style>
.clothing-card {
    transition: all 0.3s ease;
    cursor: pointer;
}

.clothing-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 0.5rem 1.5rem rgba(111, 66, 193, 0.2) !important;
}

.clothing-image {
    width: 100%;
    height: auto;
    min-height: 200px;
    max-height: 300px;
    object-fit: contain;
    object-position: center;
    background-color: #f8f9fa;
    border-radius: 8px 8px 0 0;
    transition: transform 0.3s ease;
}

.image-container {
    overflow: hidden;
    border-radius: 8px 8px 0 0;
}

.image-container:hover .clothing-image {
    transform: scale(1.05);
}

.image-zoom-overlay {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.5);
    display: flex;
    align-items: center;
    justify-content: center;
    opacity: 0;
    transition: opacity 0.3s ease;
    border-radius: 8px 8px 0 0;
}

.image-container:hover .image-zoom-overlay {
    opacity: 1;
}

.image-zoom-overlay i {
    font-size: 2rem;
}

.favorite-btn {
    background: rgba(0, 0, 0, 0.5);
    backdrop-filter: blur(4px);
    width: 32px;
    height: 32px;
    border-radius: 50%;
    transition: all 0.3s ease;
}

.favorite-btn:hover {
    background: rgba(0, 0, 0, 0.7);
    transform: scale(1.1);
}

.favorite-btn.favorited {
    background: rgba(0, 0, 0, 0.5);
}

.favorite-btn.favorited:hover {
    background: rgba(0, 0, 0, 0.7);
}

.badge {
    font-size: 0.7rem;
}

.card-footer {
    margin-top: auto;
}

.empty-state i {
    opacity: 0.5;
}

.form-select:focus,
.form-control:focus {
    border-color: var(--primary-color);
    box-shadow: 0 0 0 0.2rem rgba(111, 66, 193, 0.25);
}

.pagination .page-link {
    color: var(--primary-color);
    border-color: #dee2e6;
}

.pagination .page-item.active .page-link {
    background-color: var(--primary-color);
    border-color: var(--primary-color);
}

.pagination .page-link:hover {
    color: var(--primary-color);
    background-color: rgba(111, 66, 193, 0.1);
}

@media (max-width: 768px) {
    .clothing-image {
        height: 180px;
    }
    
    .card-title {
        font-size: 0.9rem;
    }
    
    .badge {
        font-size: 0.6rem;
    }
}
</style>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const searchInput = document.getElementById('searchInput');
    const categoryFilter = document.getElementById('categoryFilter');
    const colorFilter = document.getElementById('colorFilter');
    const clearFiltersBtn = document.getElementById('clearFilters');
    const favoriteButtons = document.querySelectorAll('.favorite-btn');
    
    // Auto-submit form on filter change
    function autoSubmitFilters() {
        const form = document.getElementById('filterForm');
        form.submit();
    }
    
    // Debounced search
    let searchTimeout;
    searchInput.addEventListener('input', function() {
        clearTimeout(searchTimeout);
        searchTimeout = setTimeout(() => {
            autoSubmitFilters();
        }, 500);
    });
    
    categoryFilter.addEventListener('change', autoSubmitFilters);
    colorFilter.addEventListener('change', autoSubmitFilters);
    
    // Clear filters
    clearFiltersBtn.addEventListener('click', function() {
        searchInput.value = '';
        categoryFilter.value = '';
        colorFilter.value = '';
        autoSubmitFilters();
    });
    
    // Favorite toggle functionality
    favoriteButtons.forEach(btn => {
        btn.addEventListener('click', async function(e) {
            e.preventDefault();
            e.stopPropagation();
            
            const itemId = this.dataset.itemId;
            const isFavorite = this.dataset.isFavorite === 'true';
            
            try {
                const response = await fetch(`/wardrobe/item/${itemId}/toggle-favorite/`, {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': '{{ csrf_token }}',
                        'Content-Type': 'application/json',
                    },
                    credentials: 'same-origin'
                });
                
                const data = await response.json();
                
                if (data.success) {
                    const icon = this.querySelector('i');
                    
                    if (data.is_favorite) {
                        icon.className = 'bi bi-heart-fill text-danger';
                        this.classList.add('favorited');
                        this.dataset.isFavorite = 'true';
                    } else {
                        icon.className = 'bi bi-heart text-white';
                        this.classList.remove('favorited');
                        this.dataset.isFavorite = 'false';
                    }
                    
                    // Show toast notification
                    AIStylist.ui.showToast(data.message, 'success');
                }
            } catch (error) {
                console.error('Error toggling favorite:', error);
                AIStylist.ui.showToast('Failed to update favorite status', 'error');
            }
        });
    });
    
    // Card click navigation (excluding favorite button)
    document.querySelectorAll('.clothing-card').forEach(card => {
        card.addEventListener('click', function(e) {
            // Don't navigate if clicking on favorite button or other interactive elements
            if (e.target.closest('.favorite-btn, .btn, .badge')) {
                return;
            }
            
            const viewLink = this.querySelector('a[href*="/item/"]');
            if (viewLink) {
                window.location.href = viewLink.href;
            }
        });
    });
    
    // Infinite scroll (placeholder for future enhancement)
    function setupInfiniteScroll() {
        // Future enhancement: Load more items as user scrolls
    }
    
    // Image lazy loading error handling
    document.querySelectorAll('.clothing-image').forEach(img => {
        img.addEventListener('error', function() {
            this.src = 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" width="200" height="200" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"/><circle cx="8.5" cy="8.5" r="1.5"/><polyline points="21,15 16,10 5,21"/></svg>';
            this.classList.add('bg-light', 'p-4', 'text-muted');
        });
    });
    
    // Image zoom functionality
    document.querySelectorAll('.image-container').forEach(container => {
        container.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            
            const img = this.querySelector('.clothing-image');
            if (img && img.dataset.fullImage) {
                const modal = new bootstrap.Modal(document.getElementById('imageModal'));
                const modalImg = document.getElementById('modalImage');
                modalImg.src = img.dataset.fullImage;
                modalImg.alt = img.alt;
                modal.show();
            }
        });
    });
});
</script>
{% endblock %}
